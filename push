#!/bin/bash
set -e

# ğŸ§ª Load .env if present
if [ -f ".env" ]; then
    echo "ğŸ“¥ Loading .env"
    set -o allexport
    source .env
    set +o allexport
fi

VERSION="$1"
OWNER="projects"           # your Gitea username or org
PACKAGE_NAME="multinut"    # your Python package name
USERNAME="Jack"            # your Gitea login username

if [[ -z "$VERSION" ]]; then
    echo "Usage: $0 <version>"
    exit 1
fi

if [[ -z "$GITEA_TOKEN" ]]; then
    echo "âŒ Please set GITEA_TOKEN environment variable"
    echo "Example: export GITEA_TOKEN=yourtoken"
    exit 1
fi

echo "ğŸŒ° Updating setup.py version to $VERSION"
sed -i "s/version=['\"]\([^'\"]*\)['\"]/version='$VERSION'/g" setup.py

echo "ğŸ§¹ Cleaning old builds"
rm -rf dist/ build/ *.egg-info

echo "ğŸ”§ Building package..."
python3 -m build

echo "ğŸš€ Uploading to Gitea: $OWNER/$PACKAGE_NAME $VERSION"
twine upload \
  --repository-url "https://git.chipperfluff.at/api/packages/$OWNER/pypi" \
  -u "$USERNAME" \
  -p "$GITEA_TOKEN" \
  dist/*

echo "âœ… Done!"
echo ""
echo "ğŸ“¦ To install:"
echo "pip install $PACKAGE_NAME --index-url https://git.chipperfluff.at/api/packages/$OWNER/pypi/simple"
